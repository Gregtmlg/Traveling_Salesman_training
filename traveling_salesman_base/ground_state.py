import numpy as np
import random

class GroundState:
    def __init__(self, nb_goals=5) -> None:
        self.grid_waypoints =[[-60, -70, -7], [-40, -70, -7], [-20, -70, -7], [0, -70, -7], [20, -70, -7], [40, -70, -7], [60, -70, -7], [80, -70, -7], 
                    [-70, -60, -7], [-50, -60, -7], [-30, -60, -7], [-10, -60, -7], [10, -60, -7], [30, -60, -7], [50, -60, -7], [70, -60, -7], [90, -60, -7], 
                    [-60, -50, -7], [-40, -50, -7], [-20, -50, -7], [0, -50, -7], [20, -50, -7], [40, -50, -7], [60, -50, -7], [80, -50, -7], 
                    [-70, -40, -7], [-50, -40, -7], [-30, -40, -7], [-10, -40, -7], [10, -40, -7], [30, -40, -7], [50, -40, -7], [70, -40, -7], [90, -40, -7], 
                    [-60, -30, -7], [-40, -30, -7], [-20, -30, -7], [0, -30, -7], [20, -30, -7], [40, -30, -7], [60, -30, -7], [80, -30, -7], 
                    [-70, -20, -7], [-50, -20, -7], [-30, -20, -7], [-10, -20, -7], [10, -20, -7], [30, -20, -7], [50, -20, -7], [70, -20, -7], [90, -20, -7], 
                    [-60, -10, -7], [-40, -10, -7], [-20, -10, -7], [0, -10, -7], [20, -10, -7], [40, -10, -7], [60, -10, -7], [80, -10, -7], 
                    [-70, 0, -7], [-50, 0, -7], [-30, 0, -7], [-10, 0, -7], [10, 0, -7], [30, 0, -7], [50, 0, -7], [70, 0, -7], [90, 0, -7], 
                    [-60, 10, -7], [-40, 10, -7], [-20, 10, -7], [0, 10, -7], [20, 10, -7], [40, 10, -7], [60, 10, -7], [80, 10, -7], 
                    [-70, 20, -7], [-50, 20, -7], [-30, 20, -7], [-10, 20, -7], [10, 20, -7], [30, 20, -7], [50, 20, -7], [70, 20, -7], [90, 20, -7], 
                    [-60, 30, -7], [-40, 30, -7], [-20, 30, -7], [0, 30, -7], [20, 30, -7], [40, 30, -7], [60, 30, -7], [80, 30, -7], 
                    [-70, 40, -7], [-50, 40, -7], [-30, 40, -7], [-10, 40, -7], [10, 40, -7], [30, 40, -7], [50, 40, -7], [70, 40, -7], [90, 40, -7], 
                    [-60, 50, -7], [-40, 50, -7], [-20, 50, -7], [0, 50, -7], [20, 50, -7], [40, 50, -7], [60, 50, -7], [80, 50, -7], 
                    [-70, 60, -7], [-50, 60, -7], [-30, 60, -7], [-10, 60, -7], [10, 60, -7], [30, 60, -7], [50, 60, -7], [70, 60, -7], [90, 60, -7], 
                    [-60, 70, -7], [-40, 70, -7], [-20, 70, -7], [0, 70, -7], [20, 70, -7], [40, 70, -7], [60, 70, -7], [80, 70, -7], 
                    [-70, 80, -7], [-50, 80, -7], [-30, 80, -7], [-10, 80, -7], [10, 80, -7], [30, 80, -7], [50, 80, -7], [70, 80, -7], [90, 80, -7], 
                    [-60, 90, -7], [-40, 90, -7], [-20, 90, -7], [0, 90, -7], [20, 90, -7], [40, 90, -7], [60, 90, -7], [80, 90, -7]]
        self.corners_n_actions= [[[-70, -70, 6], [-50, -70, 6], [-70, -50, 6], [-50, -50, 6], 'scan'], 
                                [[-50, -70, 6], [-30, -70, 6], [-50, -50, 6], [-30, -50, 6], 'evit'], 
                                [[-30, -70, 6], [-10, -70, 6], [-30, -50, 6], [-10, -50, 6], 'scan'],
                                [[-10, -70, 6], [10, -70, 6], [-10, -50, 6], [10, -50, 6], 'evit'],
                                [[10, -70, 6], [30, -70, 6], [10, -50, 6], [30, -50, 6], 'scan'], 
                                [[30, -70, 6], [50, -70, 6], [30, -50, 6], [50, -50, 6], 'evit'], 
                                [[50, -70, 6], [70, -70, 6], [50, -50, 6], [70, -50, 6], 'scan'], 
                                [[70, -70, 6], [90, -70, 6], [70, -50, 6], [90, -50, 6], 'scan'], 
                                [[-70, -50, 6], [-50, -50, 6], [-70, -30, 6], [-50, -30, 6], 'scan'], 
                                [[-50, -50, 6], [-30, -50, 6], [-50, -30, 6], [-30, -30, 6], 'evit'], 
                                [[-30, -50, 6], [-10, -50, 6], [-30, -30, 6], [-10, -30, 6], 'scan'], 
                                [[-10, -50, 6], [10, -50, 6], [-10, -30, 6], [10, -30, 6], 'scan'], 
                                [[10, -50, 6], [30, -50, 6], [10, -30, 6], [30, -30, 6], 'scan'], 
                                [[30, -50, 6], [50, -50, 6], [30, -30, 6], [50, -30, 6], 'evit'], 
                                [[50, -50, 6], [70, -50, 6], [50, -30, 6], [70, -30, 6], 'scan'], 
                                [[70, -50, 6], [90, -50, 6], [70, -30, 6], [90, -30, 6], 'scan'], 
                                [[-70, -30, 6], [-50, -30, 6], [-70, -10, 6], [-50, -10, 6], 'scan'], 
                                [[-50, -30, 6], [-30, -30, 6], [-50, -10, 6], [-30, -10, 6], 'scan'], 
                                [[-30, -30, 6], [-10, -30, 6], [-30, -10, 6], [-10, -10, 6], 'evit'], 
                                [[-10, -30, 6], [10, -30, 6], [-10, -10, 6], [10, -10, 6], 'scan'], 
                                [[10, -30, 6], [30, -30, 6], [10, -10, 6], [30, -10, 6], 'evit'], 
                                [[30, -30, 6], [50, -30, 6], [30, -10, 6], [50, -10, 6], 'scan'], 
                                [[50, -30, 6], [70, -30, 6], [50, -10, 6], [70, -10, 6], 'evit'], 
                                [[70, -30, 6], [90, -30, 6], [70, -10, 6], [90, -10, 6], 'evit'], 
                                [[-70, -10, 6], [-50, -10, 6], [-70, 10, 6], [-50, 10, 6], 'evit'], 
                                [[-50, -10, 6], [-30, -10, 6], [-50, 10, 6], [-30, 10, 6], 'evit'], 
                                [[-30, -10, 6], [-10, -10, 6], [-30, 10, 6], [-10, 10, 6], 'evit'], 
                                [[-10, -10, 6], [10, -10, 6], [-10, 10, 6], [10, 10, 6], 'evit'], 
                                [[10, -10, 6], [30, -10, 6], [10, 10, 6], [30, 10, 6], 'scan'], 
                                [[30, -10, 6], [50, -10, 6], [30, 10, 6], [50, 10, 6], 'evit'], 
                                [[50, -10, 6], [70, -10, 6], [50, 10, 6], [70, 10, 6], 'scan'], 
                                [[70, -10, 6], [90, -10, 6], [70, 10, 6], [90, 10, 6], 'scan'], 
                                [[-70, 10, 6], [-50, 10, 6], [-70, 30, 6], [-50, 30, 6], 'scan'], 
                                [[-50, 10, 6], [-30, 10, 6], [-50, 30, 6], [-30, 30, 6], 'scan'], 
                                [[-30, 10, 6], [-10, 10, 6], [-30, 30, 6], [-10, 30, 6], 'evit'], 
                                [[-10, 10, 6], [10, 10, 6], [-10, 30, 6], [10, 30, 6], 'scan'], 
                                [[10, 10, 6], [30, 10, 6], [10, 30, 6], [30, 30, 6], 'evit'], 
                                [[30, 10, 6], [50, 10, 6], [30, 30, 6], [50, 30, 6], 'scan'], 
                                [[50, 10, 6], [70, 10, 6], [50, 30, 6], [70, 30, 6], 'evit'], 
                                [[70, 10, 6], [90, 10, 6], [70, 30, 6], [90, 30, 6], 'scan'], 
                                [[-70, 30, 6], [-50, 30, 6], [-70, 50, 6], [-50, 50, 6], 'scan'],
                                [[-50, 30, 6], [-30, 30, 6], [-50, 50, 6], [-30, 50, 6], 'evit'], 
                                [[-30, 30, 6], [-10, 30, 6], [-30, 50, 6], [-10, 50, 6], 'scan'], 
                                [[-10, 30, 6], [10, 30, 6], [-10, 50, 6], [10, 50, 6], 'evit'], 
                                [[10, 30, 6], [30, 30, 6], [10, 50, 6], [30, 50, 6], 'scan'], 
                                [[30, 30, 6], [50, 30, 6], [30, 50, 6], [50, 50, 6], 'evit'], 
                                [[50, 30, 6], [70, 30, 6], [50, 50, 6], [70, 50, 6], 'evit'], 
                                [[70, 30, 6], [90, 30, 6], [70, 50, 6], [90, 50, 6], 'evit'], 
                                [[-70, 50, 6], [-50, 50, 6], [-70, 70, 6], [-50, 70, 6], 'evit'], 
                                [[-50, 50, 6], [-30, 50, 6], [-50, 70, 6], [-30, 70, 6], 'scan'], 
                                [[-30, 50, 6], [-10, 50, 6], [-30, 70, 6], [-10, 70, 6], 'evit'], 
                                [[-10, 50, 6], [10, 50, 6], [-10, 70, 6], [10, 70, 6], 'scan'],
                                [[10, 50, 6], [30, 50, 6], [10, 70, 6], [30, 70, 6], 'evit'], 
                                [[30, 50, 6], [50, 50, 6], [30, 70, 6], [50, 70, 6], 'scan'], 
                                [[50, 50, 6], [70, 50, 6], [50, 70, 6], [70, 70, 6], 'evit'], 
                                [[70, 50, 6], [90, 50, 6], [70, 70, 6], [90, 70, 6], 'evit'], 
                                [[-70, 70, 6], [-50, 70, 6], [-70, 90, 6], [-50, 90, 6], 'evit'],
                                [[-50, 70, 6], [-30, 70, 6], [-50, 90, 6], [-30, 90, 6], 'scan'], 
                                [[-30, 70, 6], [-10, 70, 6], [-30, 90, 6], [-10, 90, 6], 'scan'], 
                                [[-10, 70, 6], [10, 70, 6], [-10, 90, 6], [10, 90, 6], 'evit'],
                                [[10, 70, 6], [30, 70, 6], [10, 90, 6], [30, 90, 6], 'scan'],
                                [[30, 70, 6], [50, 70, 6], [30, 90, 6], [50, 90, 6], 'scan'],
                                [[50, 70, 6], [70, 70, 6], [50, 90, 6], [70, 90, 6], 'evit'],
                                [[70, 70, 6], [90, 70, 6], [70, 90, 6], [90, 90, 6], 'evit']]
        self.init_array = np.array([[-70,-60,-7], [-70,-40,-7], [-70,-20,-7], [-70,0,-7], [-70,20,-7], [-70,40,-7], [-70,60,-7], [-70,80,-7],
                               [-60,90,-7], [-40,90,-7], [-20,90,-7], [0,90,-7], [20,90,-7], [40,90,-7], [60,90,-7], [80,90,-7],
                               [90,80,-7], [90,60,-7], [90,40,-7], [90,20,-7], [90,0,-7], [90,-20,-7], [90,-40,-7], [90,-60,-7],
                               [80,-70,-7], [60,-70,-7], [40,-70,-7], [20,-70,-7], [0,-70,-7], [-20,-70,-7], [-40,-70,-7], [-60,-70,-7]])
        self.goals = np.zeros((nb_goals,4))
        self.nb_goals = nb_goals
        self.goal_areas = []
        self.__x_min = -70
        self.__x_max = 90
        self.__y_min = -70
        self.__y_max = 90
        self.__depth_min = -8
        self.__depth_max = 0
        
    def action_to_waypoint(self, action, current_rov_position):
        waypoint = np.array(self.__possible_next_waypnts(current_rov_position)[int(action)])
        return waypoint

    def is_wpnt_inbound(self, coordinates):
        if [coordinates[0], coordinates[1], coordinates[2]] in self.grid_waypoints:
             return True
        else:
             return False
        
    def reset_goals(self):
        self.goals[:,0:3] = self.__define_new_goals()
        self.goals[:,3] = 0
        return self.goals
    
    def reset_init_position(self):
        n = random.randint(0, len(self.init_array)-1)
        init_pose = self.init_array[n]
        return init_pose
        
    def update_goal_reached(self, current_position, last_position):
        current_area = self.__identify_area(current_position, last_position)
        goal_idx = self.__check_goal_reached(current_area)
        if goal_idx == -1:
            return self.goals
        else:
            self.goals[goal_idx,4] = 1
            return self.goals
    
    def get_parameters(self):
        return self.__x_min, self.__x_max, self.__y_min, self.__y_max, self.__depth_min, self.__depth_max

    def __check_goal_reached(self, current_area):
        for i in range(len(self.goal_areas)):
            if current_area == self.goal_areas[i][0:4]:
                return i
        return -1

    def __identify_area(self, current_position, last_position):
        x_last, y_last, z_last = last_position[0], last_position[1], last_position[2]
        x_cur, y_cur = current_position[0], current_position[1]
        if abs(x_last-x_cur) == 10:
            current_area = [[min(x_last, x_cur), min(y_last, y_cur), z_last], [max(x_last, x_cur)+10, min(y_last, y_cur), z_last], 
                             [min(x_last, x_cur), max(y_last, y_cur)+10, z_last], [max(x_last, x_cur)+10, max(y_last, y_cur)+10, z_last]]
        elif x_last==x_cur:
            current_area = [[min(x_last, x_cur)-10, min(y_last, y_cur), z_last], [max(x_last, x_cur)+10, min(y_last, y_cur), z_last], [min(x_last, x_cur)-10, max(y_last, y_cur), z_last], 
                             [max(x_last, x_cur)+10, max(y_last, y_cur), z_last]]
        elif y_last==y_last:
            current_area = [[min(x_last, x_cur), min(y_last, y_cur)-10, z_last], [max(x_last, x_cur), min(y_last, y_cur)-10, z_last], 
                             [min(x_last, x_cur), max(y_last, y_cur)+10, z_last], [max(x_last, x_cur), max(y_last, y_cur)+10, z_last]]

        return current_area
    
    def __define_new_goals(self):
        goal_possible_areas = [self.corners_n_actions[k] for k in range(len(self.corners_n_actions)) if self.corners_n_actions[k][4]=='scan']
        self.goal_areas = random.sample(goal_possible_areas, self.nb_goals)
        new_goals = np.zeros((self.nb_goals, 3))
        for i in range(self.nb_goals):
            x_list = [self.goal_areas[i][k][0] for k in range(len(self.goal_areas[i])-1)]
            y_list = [self.goal_areas[i][k][1] for k in range(len(self.goal_areas[i])-1)]
            new_goals[i, 0], new_goals[i, 1], new_goals[i, 2] = random.randint(min(x_list)+2, max(x_list)-2), random.randint(min(y_list)+2, max(y_list)-2), self.goal_areas[i][0][2]
        return new_goals
    
    def __possible_next_waypnts(self, current_waypoint):
        x, y, z = current_waypoint[0], current_waypoint[1], current_waypoint[2]
        if current_waypoint[0] % 20 == 0 and current_waypoint[1] % 20 != 0:
            next_waypnts_possible = np.array([[x, y+20, z], [x+10, y+10, z], [x-10, y+10, z],
                                    [x, y-20, z], [x+10, y-10, z], [x-10, y-10, z]])
        else:
            next_waypnts_possible = np.array([[x+20, y, z], [x+10, y+10, z], [x+10, y-10, z],
                                    [x-20, y, z], [x-10, y+10, z], [x-10, y-10, z]])
        return next_waypnts_possible
